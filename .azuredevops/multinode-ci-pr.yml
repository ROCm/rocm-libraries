resources:
  repositories:
  - repository: pipelines_repo
    type: github
    endpoint: ROCm
    name: ROCm/ROCm

variables:
- group: common
- template: /.azuredevops/variables-global.yml@pipelines_repo
- name: pytestFolder
  value: '.azuredevops/tests/pytest'

parameters:
- name: pytestList
  type: object
  default:
    - HelloWorld

trigger: none
pr:
  autoCancel: true
  branches:
    include:
    - develop
  paths:
    exclude:
    - .github
    - .jenkins
    - docs
    - '*.md'
    - LICENSE.txt
    - NOTICES.txt
  drafts: false

stages:
- stage: rcclStage
  displayName: 'RCCL develop PR'
  jobs:
  - deployment: rccl_pr_approval
    displayName: "CI Run Requires Approval"
    environment: rccl
  - job: rccl
    timeoutInMinutes: 180
    pool: rocm-ci_rccl_pool
    workspace:
      clean: all
    steps:
    - task: DeleteFiles@1
      inputs:
        Contents: '**/*'
    - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/checkout.yml@pipelines_repo
      parameters:
        submoduleBehaviour: recursive
    - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/build-cmake.yml@pipelines_repo
      parameters:
        installEnabled: false
        printDiskSpace: false
        extraBuildFlags: >-
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_TESTS=ON
          -DGPU_TARGETS=gfx942
          -GNinja
    - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/test.yml@pipelines_repo
      parameters:
        componentName: rccl
        testDir: $(Build.SourcesDirectory)/build/test
        testExecutable: 'LD_LIBRARY_PATH=$(Build.SourcesDirectory)/build:${LD_LIBRARY_PATH} NCCL_DEBUG=INFO RCCL_ENABLE_SIGNALHANDLER=1 ./rccl-UnitTests'
        testParameters: '--gtest_output=xml:./test_output.xml --gtest_color=yes'
    - ${{ each pytestScript in parameters.pytestList }}:
      - task: Bash@3
        displayName: Test ${{ pytestScript }}
        continueOnError: true
        inputs:
          targetType: inline
          workingDirectory: $(Build.SourcesDirectory)/$(pytestFolder)
          script: pytest ${{ pytestScript }}.py
